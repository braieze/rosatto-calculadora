<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Portal Rosato</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overscroll-behavior-y: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }
        .table-select { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        input, select, textarea { font-size: 16px !important; }
        input:disabled, select:disabled { background-color: #f9fafb; color: #9ca3af; cursor: not-allowed; }
        #refresh-spinner { transition: transform 0.3s; transform: translateY(-100%); }
        #refresh-spinner.visible { transform: translateY(60px); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-800 bg-gray-50 h-[100dvh] overflow-hidden">

    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 transition-transform duration-500">
        <div class="w-full max-w-sm text-center space-y-8 fade-in">
            <div class="flex justify-center">
                <img src="logo.png" alt="Papelera Rosato" class="h-24 object-contain drop-shadow-sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <h1 class="text-4xl font-bold text-red-700 tracking-tighter hidden">ROSATO</h1>
            </div>
            <div><h2 class="text-2xl font-bold text-gray-800">Portal del Empleado</h2><p class="text-gray-500 mt-2">Gestiona tus turnos y calcula tu salario.</p></div>
            <div class="space-y-4 w-full">
                <button id="btn-login-google" class="w-full py-3.5 px-4 bg-white border border-gray-300 text-gray-700 rounded-xl font-bold shadow-sm hover:bg-gray-50 transition flex items-center justify-center gap-3"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Ingresar con Google</button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-200"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">O continuar como</span><div class="flex-grow border-t border-gray-200"></div></div>
                <button id="btn-login-guest" class="w-full py-3.5 px-4 bg-red-600 text-white rounded-xl font-bold shadow-md hover:bg-red-700 transition active:scale-95">Invitado (Sin Guardar)</button>
            </div>
            <div class="mt-12 text-center">
                <p class="text-xs text-gray-400">Desarrollado por</p>
                <p class="text-sm font-bold text-gray-600">Braian Gomez</p>
            </div>
        </div>
    </div>

    <div id="app-layout" class="flex h-full hidden">
        <div id="profile-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
            <button id="close-modal-btn" class="absolute top-6 right-6 text-white text-4xl z-[101]">&times;</button>
            <img id="modal-img" src="" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl transform scale-95 transition-transform duration-300">
        </div>

        <div id="refresh-spinner" class="fixed top-0 left-0 w-full flex justify-center z-[60] pointer-events-none">
            <div class="bg-white p-3 rounded-full shadow-xl border border-gray-100"><i class="fa-solid fa-arrows-rotate fa-spin text-red-600 text-2xl"></i></div>
        </div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 text-gray-700 sidebar-closed md:relative md:translate-x-0 flex flex-col shadow-2xl md:shadow-none">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <img src="logo.png" alt="Logo" class="h-10 object-contain">
                <button id="close-sidebar-btn" class="md:hidden text-gray-400 hover:text-red-600 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-3">
                    <li><button onclick="window.navigateTo('home-view')" class="nav-btn w-full text-left px-4 py-3 rounded-xl transition-colors flex items-center space-x-3 bg-red-600 text-white shadow-md" data-target="home-view"><i class="fa-solid fa-house w-5 text-center"></i><span>Inicio</span></button></li>
                    <li><button onclick="window.navigateTo('monthly-history-view')" class="nav-btn w-full text-left px-4 py-3 rounded-xl transition-colors flex items-center space-x-3 hover:bg-red-50 hover:text-red-600" data-target="monthly-history-view"><i class="fa-solid fa-calendar-days w-5 text-center"></i><span>Mi Gestión</span></button></li>
                    <li><button onclick="window.navigateTo('treasury-view')" class="nav-btn w-full text-left px-4 py-3 rounded-xl transition-colors flex items-center space-x-3 hover:bg-red-50 hover:text-red-600" data-target="treasury-view"><i class="fa-solid fa-wallet w-5 text-center"></i><span>Tesorería</span></button></li>
                    <li><button onclick="window.navigateTo('ranking-view')" class="nav-btn w-full text-left px-4 py-3 rounded-xl transition-colors flex items-center space-x-3 hover:bg-red-50 hover:text-red-600" data-target="ranking-view"><i class="fa-solid fa-trophy w-5 text-center"></i><span>Ranking</span></button></li>
                    <li><button onclick="window.navigateTo('config-view')" class="nav-btn w-full text-left px-4 py-3 rounded-xl transition-colors flex items-center space-x-3 hover:bg-red-50 hover:text-red-600" data-target="config-view"><i class="fa-solid fa-gear w-5 text-center"></i><span>Configuración</span></button></li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <div id="user-info-container" class="mb-3">
                    <div id="user-info-name" class="text-sm font-bold text-gray-800 truncate">Invitado</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="user-info-team" class="text-[10px] font-bold bg-red-600 text-white px-1.5 py-0.5 rounded">Eq. A</span>
                        <div id="user-info-email" class="text-xs text-gray-400 truncate">Modo lectura</div>
                    </div>
                </div>
                <button id="auth-action-btn" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 hover:bg-red-50 hover:text-red-600 hover:border-red-200 rounded-lg text-sm font-bold transition shadow-sm flex justify-center items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> <span>Cerrar Sesión</span>
                </button>
                
                <div class="mt-4 pt-3 border-t border-gray-200 text-center">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Desarrollado por</p>
                    <p class="text-xs font-bold text-gray-700 mt-0.5">Braian Gomez</p>
                    <a href="mailto:braianezequielgomez00@gmail.com" class="text-[10px] text-red-500 hover:underline block mt-0.5">braianezequielgomez00@gmail.com</a>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-gray-50">
            <header class="bg-white shadow-sm px-4 py-3 flex justify-between items-center md:hidden sticky top-0 z-40 w-full h-16 border-b border-gray-100">
                <div class="flex items-center">
                    <button id="open-sidebar-btn" class="text-gray-600 focus:outline-none p-2 active:bg-gray-100 rounded-lg mr-3"><i class="fa-solid fa-bars text-xl"></i></button>
                    <img src="logo.png" class="h-8 object-contain">
                </div>
                <div class="flex items-center cursor-pointer" onclick="window.openImageModal()">
                    <div class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden border border-gray-200 shadow-sm">
                        <img id="header-profile-pic" src="" class="w-full h-full object-cover hidden">
                        <div id="header-profile-placeholder" class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-user"></i></div>
                    </div>
                </div>
            </header>
            <div id="sidebar-backdrop" class="fixed inset-0 bg-black/20 z-40 md:hidden hidden transition-opacity backdrop-blur-sm"></div>

            <div id="view-container" class="flex-1 overflow-y-auto p-4 md:p-8 relative pb-32 scroll-smooth">
                <div id="status-message" class="hidden mb-6 p-4 rounded-xl shadow-sm border-l-4 transition-all-300 bg-white"></div>

                <div id="home-view" class="view-section max-w-5xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-5">
                            <div class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-gray-100 overflow-hidden border-4 border-white shadow-md cursor-pointer" onclick="window.openImageModal()">
                                <img id="home-profile-pic" src="" class="w-full h-full object-cover hidden">
                                <div id="home-profile-placeholder" class="w-full h-full flex items-center justify-center text-gray-300 text-3xl"><i class="fa-solid fa-user"></i></div>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">Hola, <span id="welcome-user-name" class="text-red-600">Usuario</span></h1>
                                <div class="flex items-center gap-2 mt-1">
                                    <span id="welcome-user-team" class="text-xs font-bold bg-red-50 text-red-700 px-2 py-0.5 rounded border border-red-100">Equipo A</span>
                                    <p class="text-sm text-gray-400">Bienvenido al portal.</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right hidden md:block border-l pl-6 border-gray-200">
                            <p class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Hoy es</p>
                            <p id="header-current-date" class="text-2xl font-bold text-gray-700">...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-money-bill-wave text-6xl text-emerald-600"></i></div>
                            <h3 class="text-gray-500 font-semibold text-xs uppercase tracking-wider mb-1">Próxima Quincena (Estimada)</h3>
                            <div class="flex items-baseline gap-2"><span class="text-3xl font-extrabold text-emerald-600 truncate" id="home-next-quincena">$ 0</span></div>
                            <p id="home-payment-date" class="text-xs text-emerald-700 font-bold mt-3 bg-emerald-50 inline-block px-2 py-1 rounded-md">Calculando...</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-chart-pie text-6xl text-red-600"></i></div>
                            <h3 class="text-gray-500 font-semibold text-xs uppercase tracking-wider mb-1">Mes Actual (Proyectado)</h3>
                            <p class="text-xs text-red-600 font-bold mb-1 uppercase" id="home-current-month-label">...</p>
                            <div class="flex items-baseline"><span class="text-3xl font-extrabold text-gray-800 truncate" id="home-month-net">$ 0</span></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-regular fa-calendar-check text-red-500"></i> Próximos Francos</h3>
                        <div id="home-next-francos-container" class="flex space-x-4 overflow-x-auto hide-scroll pb-2"></div>
                    </div>
                </div>

                <div id="monthly-history-view" class="view-section hidden max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Gestión de Turnos</h2>
                        <button id="btn-generate-new" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-700 shadow-sm transition flex items-center gap-2"><i class="fa-solid fa-plus"></i> Mes Siguiente</button>
                    </div>
                    <div class="mb-6"><div id="months-chips-container" class="flex space-x-2 overflow-x-auto hide-scroll py-1"></div></div>
                    <div id="dashboard-content" class="hidden animate-fade-in space-y-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-xl border border-gray-200"><p class="text-xs text-gray-500 font-bold">HORAS EQ.</p><p class="text-xl font-bold text-red-600" id="dash-equiv-hours">0</p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200"><p class="text-xs text-gray-500 font-bold">VIÁTICOS</p><p class="text-xl font-bold text-orange-600" id="dash-viaticos-total">$ 0</p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200"><p class="text-xs text-gray-500 font-bold">PRESENTISMO</p><p class="text-xl font-bold text-blue-600" id="dash-presentismo-total">$ 0</p></div>
                            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-xs text-gray-400 font-bold">NETO FINAL</p><p class="text-xl font-bold text-emerald-400" id="dash-neto-final">$ 0</p></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-4 border-b border-gray-100 bg-white sticky top-0 z-20 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700">Detalle <span id="dash-detail-month-label" class="text-red-600"></span></h3>
                                <div class="flex gap-2">
                                    <button id="btn-delete-month" class="p-2 text-gray-400 hover:text-red-600 transition"><i class="fa-solid fa-trash"></i></button>
                                    <button id="btn-recalculate" onclick="window.saveCurrentData()" class="px-3 py-1.5 bg-gray-800 text-white rounded-lg text-xs font-bold hover:bg-black"><i class="fa-solid fa-save mr-1"></i> Guardar</button>
                                    <button id="btn-download-pdf" class="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs font-bold hover:bg-red-700"><i class="fa-solid fa-file-pdf"></i></button>
                                </div>
                            </div>
                            <div class="overflow-x-auto max-h-[500px]"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky-header"><tr><th class="px-4 py-3">Fecha</th><th class="px-4 py-3">Turno</th><th class="px-4 py-3 text-center">Fer.</th><th class="px-4 py-3 text-center text-red-600">Tarde</th><th class="px-4 py-3 text-right">H.Eq</th><th class="px-4 py-3 text-center">Ext</th><th class="px-4 py-3 text-right">Bruto</th></tr></thead><tbody id="daily-detail-tbody" class="divide-y divide-gray-100"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <div id="treasury-view" class="view-section hidden max-w-5xl mx-auto"><h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-wallet text-emerald-500 mr-2"></i> Tesorería</h2><div class="mb-6 bg-white p-2 rounded-xl border border-gray-200"><div id="treasury-chips-container" class="flex space-x-2 overflow-x-auto hide-scroll"></div></div><div id="treasury-container" class="space-y-6 animate-fade-in"></div></div>
                <div id="ranking-view" class="view-section hidden max-w-4xl mx-auto"><h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i> Ranking</h2><div id="ranking-list" class="space-y-4"></div></div>

                <div id="config-view" class="view-section hidden max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Ajustes</h2>
                        <button id="btn-toggle-edit" class="text-red-600 font-bold text-sm bg-red-50 px-4 py-2 rounded-lg border border-red-100 hover:bg-red-100 transition"><i class="fa-solid fa-pencil mr-2"></i> Editar Valores</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 space-y-6 mb-12">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 md:col-span-2 border-b border-gray-100 pb-6 flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-gray-100 border-2 border-gray-200 overflow-hidden">
                                    <img id="profile-pic-preview" src="" class="w-full h-full object-cover hidden">
                                    <div id="profile-icon-preview" class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-user text-2xl"></i></div>
                                </div>
                                <div>
                                    <input type="file" id="cfg-profilePicture" accept="image/*" class="hidden">
                                    <button onclick="document.getElementById('cfg-profilePicture').click()" class="bg-gray-800 text-white py-2 px-4 rounded-lg text-xs font-bold hover:bg-black"><i class="fa-solid fa-camera mr-2"></i> Subir Foto</button>
                                </div>
                            </div>
                            <div class="col-span-1 md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre (Gmail)</label><input type="text" id="cfg-userName" class="w-full p-3 border rounded-lg bg-gray-50 text-gray-500 font-medium" disabled></div>
                            <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tu Equipo</label><select id="cfg-teamLetter" class="w-full p-3 border rounded-lg bg-white" disabled><option value="A">Equipo A</option><option value="B">Equipo B</option><option value="C">Equipo C</option><option value="D">Equipo D</option></select></div>
                            <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Hora ($)</label><input type="number" id="cfg-valorHora" class="w-full p-3 border rounded-lg" disabled></div>
                            <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Afiliación</label><select id="cfg-discountRate" class="w-full p-3 border rounded-lg bg-white" disabled><option value="0.18">No Afiliado (18%)</option><option value="0.21">Afiliado (21%)</option></select></div>
                            <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Viático ($)</label><input type="number" id="cfg-viaticoValue" class="w-full p-3 border rounded-lg" disabled></div>
                            <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Presentismo ($)</label><input type="number" id="cfg-presentismoAmount" class="w-full p-3 border rounded-lg" disabled></div>
                            <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Título ($)</label><input type="number" id="cfg-tituloAmount" class="w-full p-3 border rounded-lg" disabled></div>
                            <div class="col-span-1 md:col-span-2 border-t border-gray-100 pt-4 mt-2">
                                <h4 class="font-bold text-red-600 mb-4 text-sm">CONFIGURACIÓN DE ROTACIÓN</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Último Franco (Día 2)</label><input type="date" id="cfg-lastFrancoDate" class="w-full p-3 border rounded-lg" disabled></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Turno Post-Franco</label><select id="cfg-initialTurn" class="w-full p-3 border rounded-lg bg-white" disabled><option value="Mañana">Mañana</option><option value="Noche">Noche</option><option value="Tarde">Tarde</option></select></div>
                                </div>
                            </div>
                        </div>
                        <button id="btn-save-config" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold hover:bg-red-700 shadow-lg hidden">GUARDAR Y APLICAR</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC_gewonkD_XnzQmwmUnQuhfzOf5zdm9lw", authDomain: "calculadora-6x2.firebaseapp.com", projectId: "calculadora-6x2", storageBucket: "calculadora-6x2.firebasestorage.app", messagingSenderId: "238926197886", appId: "1:238926197886:web:d05857b007dcb305e9d42f" };

        let app, auth, db, userId = null;
        let isEditingConfig = false;

        let appState = {
            config: { 
                userName: 'Usuario', profilePicUrl: '', teamLetter: 'A', valorHora: 0, discountRate: 0.18, 
                tituloAmount: 0, viaticoValue: 0, presentismoAmount: 0,
                lastFrancoDate: new Date().toISOString().split('T')[0], initialTurn: 'Mañana' 
            },
            viewingMonth: { month: new Date().getMonth() + 1, year: new Date().getFullYear() },
            treasuryViewMonth: { month: new Date().getMonth() + 1, year: new Date().getFullYear() },
            activeData: { extras: {}, manualHolidays: {}, shiftOverrides: {}, lateness: {}, calculation: null },
            historicalCache: {}
        };

        // --- EXPOSE GLOBALS FOR HTML HANDLERS ---
        window.navigateTo = navigateTo; 
        window.openImageModal = openImageModal;
        window.updateExtra = updateExtra; 
        window.updateHoliday = updateHoliday; 
        window.updateLateness = updateLateness; 
        window.updateTurnOverride = updateTurnOverride;
        window.handleLogout = handleLogout;
        window.saveCurrentData = saveCurrentData; 

        window.onload = () => {
            initFirebaseSystem();
            setupUI();
            setupPullToRefresh();
            const d = new Date();
            document.getElementById('header-current-date').textContent = `${d.getDate()} ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][d.getMonth()]}`;
            
            document.getElementById('btn-login-google').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
            document.getElementById('btn-login-guest').onclick = () => enterAsGuest();
            
            document.getElementById('auth-action-btn').onclick = handleLogout;
            
            document.getElementById('btn-save-config').addEventListener('click', saveConfigHandler);
            document.getElementById('btn-toggle-edit').addEventListener('click', toggleConfigEdit);
            
            const fileInput = document.getElementById('cfg-profilePicture');
            if (fileInput) fileInput.onchange = (e) => { if(e.target.files[0]) compressAndUpload(e.target.files[0]); };

            // Enlace de descarga de PDF
            document.getElementById('btn-download-pdf').onclick = generatePdfReport;
            document.getElementById('btn-generate-new').onclick = generateNextMonthData;
            document.getElementById('btn-delete-month').onclick = deleteCurrentMonthData;
        };

        // --- AUTHENTICATION & GUEST MODE ---
        function initFirebaseSystem() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info-name').textContent = user.displayName || 'Usuario';
                        document.getElementById('user-info-email').textContent = user.email || '';
                        document.getElementById('login-view').style.transform = 'translateY(-100%)';
                        document.getElementById('app-layout').classList.remove('hidden');
                        subscribeToUserData();
                        document.getElementById('auth-action-btn').innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> <span>Cerrar Sesión</span>';
                        document.getElementById('auth-action-btn').classList.remove('bg-red-600', 'text-white', 'border-red-600', 'hover:bg-red-700');
                        document.getElementById('auth-action-btn').classList.add('bg-white', 'text-gray-700', 'border-gray-300', 'hover:bg-red-50', 'hover:text-red-600', 'hover:border-red-200');
                    } else {
                        showLoginView();
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase. Posiblemente por modo offline o configuracion.", e);
                // Permite entrar en modo invitado si falla Firebase
                showLoginView();
            }
        }
        
        function showLoginView() {
            userId = null;
            document.getElementById('login-view').style.transform = 'translateY(0)';
            document.getElementById('app-layout').classList.add('hidden');
            document.getElementById('auth-action-btn').innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> <span>Cerrar Sesión</span>';
        }
        
        async function handleLogout() {
            if (userId === null) {
                // Modo invitado: Volver a la pantalla de login
                showLoginView();
            } else {
                // Usuario autenticado: Cerrar sesión de Firebase
                await signOut(auth);
            }
        }

        function enterAsGuest() {
            userId = null;
            document.getElementById('login-view').style.transform = 'translateY(-100%)';
            document.getElementById('app-layout').classList.remove('hidden');

            // ACTUALIZA BOTÓN PARA MODO INVITADO
            const authBtn = document.getElementById('auth-action-btn');
            authBtn.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> <span>Volver al Login</span>';
            authBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300', 'hover:bg-red-50', 'hover:text-red-600', 'hover:border-red-200');
            authBtn.classList.add('bg-red-600', 'text-white', 'border-red-600', 'hover:bg-red-700');
            
            // Actualiza info en sidebar
            document.getElementById('user-info-name').textContent = 'Invitado';
            document.getElementById('user-info-email').textContent = 'Modo lectura';
            updateProfilePictureUI(appState.config.profilePicUrl);
            
            // Genera datos para el mes actual con la configuración predeterminada
            const now = new Date();
            appState.viewingMonth = { month: now.getMonth() + 1, year: now.getFullYear() };
            appState.activeData.calculation = getCalculationFor(now.getMonth() + 1, now.getFullYear(), true);
            appState.historicalCache = {}; // No hay historial en modo invitado

            renderHome();
        }
        // --- END AUTHENTICATION & GUEST MODE ---

        // --- CONFIGURATION MANAGEMENT ---
        function toggleConfigEdit() {
            isEditingConfig = !isEditingConfig;
            const inputs = document.querySelectorAll('#config-view input:not([type="file"]), #config-view select');
            const saveBtn = document.getElementById('btn-save-config');
            const editBtn = document.getElementById('btn-toggle-edit');
            inputs.forEach(inp => { if(inp.id !== 'cfg-userName') inp.disabled = !isEditingConfig; });
            if(isEditingConfig) {
                saveBtn.classList.remove('hidden');
                editBtn.innerHTML = '<i class="fa-solid fa-times mr-2"></i> Cancelar';
                editBtn.classList.replace('text-red-600', 'text-gray-600'); editBtn.classList.replace('bg-red-50', 'bg-gray-100');
            } else {
                saveBtn.classList.add('hidden');
                editBtn.innerHTML = '<i class="fa-solid fa-pencil mr-2"></i> Editar Valores';
                editBtn.classList.replace('text-gray-600', 'text-red-600'); editBtn.classList.replace('bg-gray-100', 'bg-red-50');
                fillConfigInputs();
            }
        }

        function fillConfigInputs() {
            document.getElementById('cfg-userName').value = appState.config.userName;
            document.getElementById('cfg-teamLetter').value = appState.config.teamLetter;
            document.getElementById('cfg-valorHora').value = appState.config.valorHora;
            document.getElementById('cfg-discountRate').value = appState.config.discountRate;
            document.getElementById('cfg-viaticoValue').value = appState.config.viaticoValue;
            document.getElementById('cfg-presentismoAmount').value = appState.config.presentismoAmount;
            document.getElementById('cfg-tituloAmount').value = appState.config.tituloAmount;
            document.getElementById('cfg-lastFrancoDate').value = appState.config.lastFrancoDate;
            document.getElementById('cfg-initialTurn').value = appState.config.initialTurn;
        }

        async function saveConfigHandler() {
            const newConfig = {
                userName: document.getElementById('cfg-userName').value,
                teamLetter: document.getElementById('cfg-teamLetter').value,
                valorHora: Number(document.getElementById('cfg-valorHora').value),
                discountRate: Number(document.getElementById('cfg-discountRate').value),
                viaticoValue: Number(document.getElementById('cfg-viaticoValue').value),
                presentismoAmount: Number(document.getElementById('cfg-presentismoAmount').value),
                tituloAmount: Number(document.getElementById('cfg-tituloAmount').value),
                lastFrancoDate: document.getElementById('cfg-lastFrancoDate').value,
                initialTurn: document.getElementById('cfg-initialTurn').value,
                profilePicUrl: appState.config.profilePicUrl // Mantener la URL de la imagen
            };

            if (userId) {
                try {
                    await setDoc(doc(db, 'artifacts', firebaseConfig.appId, 'users', userId, 'config', 'salary'), newConfig, { merge: true });
                    showMessage('Configuración guardada.', 'success');
                } catch(e) {
                    console.error("Error al guardar configuración:", e);
                    showMessage('Error al guardar la configuración.', 'error');
                }
            } else {
                // Modo invitado: Solo actualiza el estado local
                appState.config = newConfig;
                showMessage('Configuración aplicada localmente.', 'success');
                renderHome(); // Refrescar la vista de inicio
            }

            toggleConfigEdit();
        }

        function updateConfigUI(config) {
            appState.config = { ...appState.config, ...config };
            document.getElementById('welcome-user-name').textContent = appState.config.userName;
            document.getElementById('welcome-user-team').textContent = `Equipo ${appState.config.teamLetter}`;
            document.getElementById('user-info-name').textContent = appState.config.userName;
            document.getElementById('user-info-team').textContent = `Eq. ${appState.config.teamLetter}`;
            updateProfilePictureUI(appState.config.profilePicUrl);
            fillConfigInputs();
        }
        // --- END CONFIGURATION MANAGEMENT ---

        // --- FIREBASE LISTENERS ---
        function subscribeToUserData() {
            if (!userId || !db) return;
            // Listener de Configuración
            onSnapshot(doc(db, 'artifacts', firebaseConfig.appId, 'users', userId, 'config', 'salary'), (docSnap) => {
                if (docSnap.exists()) {
                    updateConfigUI(docSnap.data());
                } else {
                    // Crea la configuración inicial si no existe
                    const initialConfig = { ...appState.config, userName: auth.currentUser?.displayName || 'Usuario', profilePicUrl: auth.currentUser?.photoURL || '' };
                    setDoc(doc(db, 'artifacts', firebaseConfig.appId, 'users', userId, 'config', 'salary'), initialConfig, { merge: true });
                    updateConfigUI(initialConfig);
                }
                
                // Vuelve a calcular el mes actual con la nueva configuración
                const { month, year } = new Date();
                appState.activeData.calculation = getCalculationFor(month + 1, year, true);
                renderHome(); // Refresca Home
                if (document.getElementById('monthly-history-view').classList.contains('hidden') === false) {
                    renderDashboard(); // Refresca Dashboard si está visible
                }
            });

            // Listener de Datos Históricos
            onSnapshot(collection(db, 'artifacts', firebaseConfig.appId, 'users', userId, 'data'), (querySnapshot) => {
                const newCache = {};
                querySnapshot.forEach(doc => {
                    newCache[doc.id] = doc.data();
                });
                appState.historicalCache = newCache;
                renderDashboardChips(); // Actualiza los chips de meses
                
                // Recalcula el mes activo en caso de actualización remota
                const { month, year } = appState.viewingMonth;
                const key = `${year}-${String(month).padStart(2, '0')}`;
                if (appState.historicalCache[key]) {
                    appState.activeData = appState.historicalCache[key];
                    appState.activeData.calculation = performCalculation(month, year, appState.activeData.extras||{}, appState.activeData.manualHolidays||{}, appState.activeData.shiftOverrides||{}, appState.activeData.lateness||{}, appState.activeData.configSnapshot || appState.config);
                    if (document.getElementById('monthly-history-view').classList.contains('hidden') === false) {
                        renderDashboardDetails();
                    }
                }
            });
        }
        // --- END FIREBASE LISTENERS ---
        
        // --- VISUAL UI UTILITIES ---
        function updateProfilePictureUI(url) {
            const elements = ['header-profile-pic', 'home-profile-pic', 'profile-pic-preview'];
            const placeholders = ['header-profile-placeholder', 'home-profile-placeholder', 'profile-icon-preview'];

            if (url) {
                elements.forEach(id => {
                    const img = document.getElementById(id);
                    img.src = url;
                    img.classList.remove('hidden');
                });
                placeholders.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            } else {
                elements.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                placeholders.forEach(id => {
                    document.getElementById(id).classList.remove('hidden');
                });
            }
        }

        function openImageModal() {
            const src = document.getElementById('header-profile-pic').src;
            if(!src) return;
            const modal = document.getElementById('profile-modal');
            const img = document.getElementById('modal-img');
            img.src = src; modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); img.classList.remove('scale-95'); }, 10);
        }
        document.getElementById('close-modal-btn').onclick = closeModal;
        document.getElementById('profile-modal').onclick = (e) => { if(e.target.id === 'profile-modal') closeModal(); };
        function closeModal() { const modal = document.getElementById('profile-modal'); const img = document.getElementById('modal-img'); modal.classList.add('opacity-0'); img.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); }

        function setupUI() {
            const sidebar = document.getElementById('sidebar'); const backdrop = document.getElementById('sidebar-backdrop');
            const closeMenu = () => { sidebar.classList.add('sidebar-closed'); sidebar.classList.remove('sidebar-open'); backdrop.classList.add('hidden'); };
            document.getElementById('open-sidebar-btn').onclick = () => { sidebar.classList.remove('sidebar-closed'); sidebar.classList.add('sidebar-open'); backdrop.classList.remove('hidden'); };
            document.getElementById('close-sidebar-btn').onclick = closeMenu; backdrop.onclick = closeMenu;
        }

        function setupPullToRefresh() {
            let touchStart = 0; const spinner = document.getElementById('refresh-spinner');
            window.addEventListener('touchstart', e => { if (window.scrollY === 0) touchStart = e.touches[0].clientY; }, {passive: true});
            window.addEventListener('touchmove', e => { const touchY = e.touches[0].clientY; if (touchStart > 0 && touchY > touchStart && window.scrollY === 0) { if (touchY - touchStart > 150) spinner.classList.add('visible'); } }, {passive: true});
            window.addEventListener('touchend', e => { const touchY = e.changedTouches[0].clientY; if (touchStart > 0 && touchY - touchStart > 150 && window.scrollY === 0) { location.reload(); } spinner.classList.remove('visible'); touchStart = 0; });
        }

        function navigateTo(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => { 
                if(btn.dataset.target === viewId) { btn.classList.remove('text-gray-700','hover:bg-red-50','hover:text-red-600'); btn.classList.add('bg-red-600', 'text-white', 'shadow-md'); } 
                else { btn.classList.add('text-gray-700','hover:bg-red-50','hover:text-red-600'); btn.classList.remove('bg-red-600', 'text-white', 'shadow-md'); } 
            });
            if (viewId === 'home-view') renderHome();
            if (viewId === 'monthly-history-view') renderDashboard();
            if (viewId === 'ranking-view') renderRanking();
            if (viewId === 'treasury-view') renderTreasury();
            if (viewId === 'config-view') fillConfigInputs();
            
            if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('sidebar-closed'); document.getElementById('sidebar').classList.remove('sidebar-open'); document.getElementById('sidebar-backdrop').classList.add('hidden'); }
        }

        function showMessage(msg, type) {
            const el = document.getElementById('status-message');
            el.textContent = msg;
            el.classList.remove('hidden', 'bg-red-50', 'border-red-500', 'bg-green-50', 'border-green-500', 'bg-blue-50', 'border-blue-500');
            if (type === 'success') { el.classList.add('bg-green-50', 'border-green-500'); }
            else if (type === 'error') { el.classList.add('bg-red-50', 'border-red-500'); }
            else { el.classList.add('bg-blue-50', 'border-blue-500'); }
            el.scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        // --- END VISUAL UI UTILITIES ---

        // --- CALCULATION LOGIC ---
        function performCalculation(month, year, extras, holidays, overrides, lateness, configOverride) {
            const cfg = configOverride || appState.config;
            const { lastFrancoDate, initialTurn, valorHora, discountRate, tituloAmount, viaticoValue, presentismoAmount } = cfg;
            const safeValHora = Number(valorHora) || 0; const safeViat = Number(viaticoValue) || 0;
            const safePres = Number(presentismoAmount) || 0; const safeTitulo = Number(tituloAmount) || 0;

            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyResults = []; const francosList = [];
            const masterCycle = ['Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Franco', 'Franco', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'];
            let baseOffset = (initialTurn === 'Noche') ? 8 : (initialTurn === 'Tarde' ? 16 : 0);
            let lastFrancoMs = new Date().getTime();
            if (lastFrancoDate) { const parts = lastFrancoDate.split('-'); const localLF = new Date(parts[0], parts[1] - 1, parts[2]); lastFrancoMs = localLF.getTime() + 86400000; }
            
            const diffDays = Math.floor((new Date(year, month - 1, 1).getTime() - lastFrancoMs) / 86400000);
            let startOffset = (baseOffset + diffDays) % 24; if (startOffset < 0) startOffset += 24;

            let q1_bruto = 0, q2_bruto = 0, q1_viaticos = 0, q2_viaticos = 0, q1_fer = 0, q2_fer = 0;
            let hasLateness = false;
            let brutoTotal = 0;

            for (let i = 1; i <= daysInMonth; i++) {
                const current = new Date(year, month - 1, i);
                const dKey = current.toISOString().split('T')[0];
                const dDisp = current.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year:'numeric'});
                let cState = masterCycle[startOffset];
                if (overrides && overrides[dKey] && overrides[dKey] !== 'Original') cState = overrides[dKey];
                const isHol = holidays[dDisp] === true; const ext = extras[dDisp] || 0;
                const isLate = lateness && lateness[dDisp] === true; if(isLate) hasLateness = true;

                let tLbl = cState, eqBase = 0, isTardeOrNoche = (cState === 'Tarde' || cState === 'Noche');
                
                if (cState === 'Vacaciones' || cState === 'Licencia') { 
                    tLbl = cState; eqBase = 8; 
                } else if (cState === 'Franco') {
                    francosList.push({ dayNum: i, dayName: ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'][current.getDay()], fullDate: dDisp, isHoliday: isHol });
                    if (isHol) { tLbl = 'FERIADO (Franco)'; eqBase = 8; } // Feriado que cae en Franco se paga 8hs
                } else { // Mañana, Tarde, Noche
                    if (isHol) { 
                        tLbl = `FERIADO (${cState})`; 
                        eqBase = 32; // 8hs normales + 8hs feriado al 100% + 8hs feriado al 100% (24hs)
                    } else {
                        eqBase = 8; // Base
                        const d = current.getDay();
                        // Turnos noche o tarde en fin de semana/días especiales
                        if (d===0) eqBase = 24; // Domingo (8 + 16/2)
                        else if(d===6) eqBase = 12; // Sábado (8 + 4/2)
                        else if(d>=1 && d<=5 && cState==='Noche') eqBase = 12; // Noche en día de semana
                    }
                }
                
                // Corrección Crítica de Sintaxis: El problema estaba en la línea de abajo.
                const eqTot = eqBase + (ext * 1.5); 
                
                const dBruto = eqTot * safeValHora; 
                const dViat = ext > 0 ? safeViat : 0;
                
                dailyResults.push({ date: dDisp, key: dKey, dayName: ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'][current.getDay()], turn: tLbl, isHoliday: isHol, isLate: isLate, isTardeNoche: isTardeOrNoche, equivBase: eqBase, extraReal: ext, totalEquiv: eqTot, bruto: dBruto, isFranco: cState === 'Franco' });
                
                if (i <= 15) { q1_bruto += dBruto; q1_viaticos += dViat; if(isHol) q1_fer += dBruto; } else { q2_bruto += dBruto; q2_viaticos += dViat; if(isHol) q2_fer += dBruto; }
                
                brutoTotal += dBruto;
                startOffset = (startOffset + 1) % 24;
            }
            const pres = hasLateness ? 0 : safePres;
            const q1_desc = q1_bruto * discountRate;
            const q2_desc = q2_bruto * discountRate;
            const q1_n = q1_bruto - q1_desc + q1_viaticos;
            const q2_n = q2_bruto - q2_desc + q2_viaticos + safeTitulo + pres;
            
            return { 
                dailyResults, francosList, 
                totalEquivHours: dailyResults.reduce((a,b)=>a+b.totalEquiv,0), 
                totalViaticos: q1_viaticos + q2_viaticos, 
                tituloAmount: safeTitulo, 
                presentismo: pres, 
                hasLateness, 
                brutoTotal: brutoTotal, 
                descuentoTotal: q1_desc + q2_desc, 
                netoFinal: q1_n + q2_n, 
                totalFeriadosAmt: q1_fer + q2_fer, 
                quincenas: { 
                    q1: { bruto: q1_bruto, neto: q1_n, viaticos: q1_viaticos, desc: q1_desc, feriados: q1_fer }, 
                    q2: { bruto: q2_bruto, neto: q2_n, viaticos: q2_viaticos, desc: q2_desc, feriados: q2_fer, titulo: safeTitulo, presentismo: pres } 
                } 
            };
        }

        function getCalculationFor(m, y, isHome = false) {
            const key = `${y}-${String(m).padStart(2,'0')}`;
            const cached = appState.historicalCache[key];
            
            if (isHome || (!cached && appState.viewingMonth.month === m && appState.viewingMonth.year === y)) {
                return performCalculation(m, y, cached?.extras||{}, cached?.manualHolidays||{}, cached?.shiftOverrides||{}, cached?.lateness||{}, appState.config);
            }
            
            if (cached) {
                return performCalculation(m, y, cached.extras||{}, cached.manualHolidays||{}, cached.shiftOverrides||{}, cached.lateness||{}, cached.configSnapshot || appState.config);
            }
            
            return performCalculation(m, y, {}, {}, {}, {}, appState.config);
        }

        // --- DASHBOARD DATA MANAGEMENT ---
        function generateNextMonthData() {
            let { month, year } = appState.viewingMonth;
            if (month === 12) { month = 1; year++; } else { month++; }
            switchDashboardMonth(month, year);
        }

        function switchDashboardMonth(month, year) {
            appState.viewingMonth = { month, year };
            const key = `${year}-${String(month).padStart(2, '0')}`;
            
            document.getElementById('dash-detail-month-label').textContent = `${month}/${year}`;
            
            if (appState.historicalCache[key]) {
                appState.activeData = appState.historicalCache[key];
                appState.activeData.calculation = performCalculation(month, year, appState.activeData.extras||{}, appState.activeData.manualHolidays||{}, appState.activeData.shiftOverrides||{}, appState.activeData.lateness||{}, appState.activeData.configSnapshot || appState.config);
            } else {
                appState.activeData = { extras: {}, manualHolidays: {}, shiftOverrides: {}, lateness: {}, calculation: getCalculationFor(month, year) };
            }
            
            renderDashboard();
            document.getElementById('dashboard-content').classList.remove('hidden');
        }

        async function saveCurrentData() {
            if (!userId) { 
                showMessage('No puedes guardar datos en modo Invitado.', 'error');
                return;
            }
            
            const { month, year } = appState.viewingMonth;
            const docId = `${year}-${String(month).padStart(2, '0')}`;
            
            // Recalcular con los datos del mes activo
            const calculation = performCalculation(
                month, year, 
                appState.activeData.extras, 
                appState.activeData.manualHolidays, 
                appState.activeData.shiftOverrides, 
                appState.activeData.lateness,
                appState.config // Siempre usa la config actual al guardar un nuevo mes
            );

            const dataToSave = {
                configSnapshot: appState.config, // Guarda la config actual como snapshot
                extras: appState.activeData.extras,
                manualHolidays: appState.activeData.manualHolidays,
                shiftOverrides: appState.activeData.shiftOverrides,
                lateness: appState.activeData.lateness,
                timestamp: new Date().toISOString()
            };

            try {
                await setDoc(doc(db, 'artifacts', firebaseConfig.appId, 'users', userId, 'data', docId), dataToSave);
                appState.historicalCache[docId] = dataToSave; // Actualiza el cache local para reflejar la config
                showMessage(`Datos de ${month}/${year} guardados.`, 'success');
                // renderDashboard() será llamado por el listener de Firestore, pero lo forzamos si no estamos logueados (aunque esto no debería pasar)
                appState.activeData.calculation = calculation;
                renderDashboardDetails();
            } catch (e) {
                console.error("Error al guardar datos:", e);
                showMessage('Error al guardar datos en Firebase.', 'error');
            }
        }
        
        async function deleteCurrentMonthData() {
            if (!userId) { 
                showMessage('No puedes borrar datos en modo Invitado.', 'error');
                return;
            }

            if(!confirm("¿Estás seguro de que quieres borrar todos los datos de este mes? Esta acción es irreversible.")) return;
            
            const { month, year } = appState.viewingMonth; 
            const docId = `${year}-${String(month).padStart(2, '0')}`;
            
            try { 
                await deleteDoc(doc(db, 'artifacts', firebaseConfig.appId, 'users', userId, 'data', docId)); 
                delete appState.historicalCache[docId]; 
                
                // Redirige al mes anterior o al mes actual si no hay historial
                const keys = Object.keys(appState.historicalCache).sort(); 
                if (keys.length > 0) { 
                    const [ly, lm] = keys[keys.length - 1].split('-'); 
                    switchDashboardMonth(parseInt(lm), parseInt(ly)); 
                } else { 
                    // Vuelve a la configuración del mes actual
                    const now = new Date(); 
                    appState.viewingMonth = { month: now.getMonth() + 1, year: now.getFullYear() }; 
                    appState.activeData = { extras: {}, manualHolidays: {}, shiftOverrides: {}, lateness: {}, calculation: getCalculationFor(now.getMonth()+1, now.getFullYear(), true) }; 
                    renderDashboard(); 
                } 
                showMessage('Datos del mes eliminados.', 'success'); 
            } catch(e) { 
                console.error("Error al borrar datos:", e); showMessage('Error al borrar los datos.', 'error'); 
            }
        }
        
        // --- HANDLERS PARA INTERACCION DE TABLA ---
        function updateExtra(date, value) {
            const val = Number(value);
            if (val > 0) { appState.activeData.extras[date] = val; } 
            else { delete appState.activeData.extras[date]; }
            recalculateAndRender();
        }

        function updateHoliday(date, isHoliday) {
            if (isHoliday) { appState.activeData.manualHolidays[date] = true; } 
            else { delete appState.activeData.manualHolidays[date]; }
            recalculateAndRender();
        }

        function updateLateness(date, isLate) {
            if (isLate) { appState.activeData.lateness[date] = true; } 
            else { delete appState.activeData.lateness[date]; }
            recalculateAndRender();
        }

        function updateTurnOverride(date, turn) {
            if (turn !== 'Original') { appState.activeData.shiftOverrides[date] = turn; }
            else { delete appState.activeData.shiftOverrides[date]; }
            recalculateAndRender();
        }

        function recalculateAndRender() {
            const { month, year } = appState.viewingMonth;
            appState.activeData.calculation = performCalculation(
                month, year, 
                appState.activeData.extras, 
                appState.activeData.manualHolidays, 
                appState.activeData.shiftOverrides, 
                appState.activeData.lateness, 
                appState.config
            );
            renderDashboardDetails();
            renderHome();
        }
        
        // --- RENDER FUNCTIONS ---
        function formatMoney(amount) {
            if (typeof amount !== 'number') return '$ 0';
            return '$ ' + Math.round(amount).toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function renderHome() {
            const now = new Date();
            const calc = getCalculationFor(now.getMonth() + 1, now.getFullYear(), true);
            const today = now.getDate();

            // Next Quincena (Q1 = 15, Q2 = fin de mes)
            let nextQuincena, paymentDate;
            if (today <= 15) {
                nextQuincena = calc.quincenas.q1.neto;
                paymentDate = new Date(now.getFullYear(), now.getMonth(), 4);
                if (paymentDate.getDay() === 0) paymentDate.setDate(5); // Si cae domingo, pasa a lunes
                else if (paymentDate.getDay() === 6) paymentDate.setDate(6); // Si cae sábado, pasa a lunes
                const [d, m] = paymentDate.toLocaleDateString('es-AR', { day:'numeric', month:'numeric' }).split('/');
                document.getElementById('home-payment-date').textContent = `Cobro est: ${d}/${m}`;
            } else {
                nextQuincena = calc.quincenas.q2.neto;
                paymentDate = new Date(now.getFullYear(), now.getMonth() + 1, 4);
                if (paymentDate.getDay() === 0) paymentDate.setDate(5);
                else if (paymentDate.getDay() === 6) paymentDate.setDate(6);
                const [d, m] = paymentDate.toLocaleDateString('es-AR', { day:'numeric', month:'numeric' }).split('/');
                document.getElementById('home-payment-date').textContent = `Cobro est: ${d}/${m}`;
            }

            document.getElementById('home-next-quincena').textContent = formatMoney(nextQuincena);
            document.getElementById('home-month-net').textContent = formatMoney(calc.netoFinal);
            document.getElementById('home-current-month-label').textContent = now.toLocaleDateString('es-AR', { month: 'long' }).toUpperCase() + ' DE ' + now.getFullYear();
            
            // Francos
            const francosHTML = (calc.francosList || []).slice(0, 4).map(f => `
                <div class="p-3 rounded-lg shadow-sm border border-gray-100 text-center ${f.isHoliday ? 'bg-red-50' : 'bg-white'}" style="min-width: 80px;">
                    <p class="text-xs font-semibold text-gray-500">${f.dayName.toUpperCase()}</p>
                    <p class="text-2xl font-bold ${f.isHoliday ? 'text-red-700' : 'text-gray-800'}">${f.dayNum}</p>
                    <p class="text-[10px] text-gray-400 mt-1">${f.isHoliday ? 'FERIADO' : 'FRANCO'}</p>
                </div>
            `).join('');
            document.getElementById('home-next-francos-container').innerHTML = francosHTML || '<p class="text-gray-500 text-sm">No hay francos programados restantes en este mes.</p>';
        }

        function renderDashboard() {
            renderDashboardChips();
            renderDashboardDetails();
        }
        
        function renderDashboardChips() {
            const container = document.getElementById('months-chips-container');
            container.innerHTML = '';
            
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            const keys = Object.keys(appState.historicalCache).sort((a, b) => b.localeCompare(a));
            const currentMonthKey = `${appState.viewingMonth.year}-${String(appState.viewingMonth.month).padStart(2,'0')}`;
            
            // Asegura que el mes actual (si no está en caché) se muestre
            if (!appState.historicalCache[currentMonthKey]) {
                keys.unshift(currentMonthKey);
            }

            keys.forEach(key => {
                const [year, month] = key.split('-');
                const m = parseInt(month);
                const isSelected = key === currentMonthKey;
                const buttonClass = isSelected 
                    ? 'bg-red-600 text-white font-bold shadow-md' 
                    : 'bg-white text-gray-700 hover:bg-gray-100';

                const button = document.createElement('button');
                button.className = `flex-shrink-0 px-4 py-2 rounded-xl text-sm transition-all ${buttonClass}`;
                button.textContent = `${monthNames[m - 1]} ${year}`;
                button.onclick = () => switchDashboardMonth(m, parseInt(year));
                container.appendChild(button);
            });
        }

        function renderDashboardDetails() {
            const calc = appState.activeData.calculation;
            if (!calc) {
                document.getElementById('dash-neto-final').textContent = '$ 0';
                document.getElementById('dash-equiv-hours').textContent = '0';
                document.getElementById('dash-viaticos-total').textContent = '$ 0';
                document.getElementById('dash-presentismo-total').textContent = '$ 0';
                document.getElementById('daily-detail-tbody').innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center text-gray-500">Aún no hay datos para este mes.</td></tr>';
                return;
            }

            document.getElementById('dash-equiv-hours').textContent = Math.round(calc.totalEquivHours);
            document.getElementById('dash-viaticos-total').textContent = formatMoney(calc.totalViaticos);
            document.getElementById('dash-presentismo-total').textContent = formatMoney(calc.presentismo);
            document.getElementById('dash-neto-final').textContent = formatMoney(calc.netoFinal);
            
            const tbody = document.getElementById('daily-detail-tbody');
            tbody.innerHTML = '';
            
            const shiftOptions = ['Original', 'Franco', 'Mañana', 'Tarde', 'Noche', 'Vacaciones', 'Licencia'];

            calc.dailyResults.forEach(day => {
                const tr = document.createElement('tr');
                tr.className = `border-b ${day.isFranco ? 'bg-gray-50 text-gray-500' : 'bg-white hover:bg-red-50/50'}`;

                // Columna 1: Fecha
                const tdDate = document.createElement('td');
                tdDate.className = 'px-4 py-3 font-semibold text-gray-900 whitespace-nowrap';
                tdDate.innerHTML = `<span class="text-xs text-gray-500 block">${day.dayName}</span>${day.date.substring(0, 5)}`;
                tr.appendChild(tdDate);

                // Columna 2: Turno / Override
                const tdTurn = document.createElement('td');
                tdTurn.className = 'px-4 py-3';
                const turnSelect = document.createElement('select');
                turnSelect.className = 'w-full p-1.5 border border-gray-300 rounded-lg bg-white table-select text-xs';
                turnSelect.onchange = (e) => window.updateTurnOverride(day.key, e.target.value);
                shiftOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt === 'Original' ? day.turn.split(' ')[0] : opt;
                    if (day.turn.includes(opt) || appState.activeData.shiftOverrides[day.key] === opt) {
                        option.selected = true;
                    }
                    if (opt === 'Original' && appState.activeData.shiftOverrides[day.key]) {
                         option.textContent = 'Original'; // Asegura que el valor original es 'Original' cuando hay override
                    }
                    turnSelect.appendChild(option);
                });
                tdTurn.appendChild(turnSelect);
                tr.appendChild(tdTurn);

                // Columna 3: Feriado Manual (Checkbox)
                const tdHoliday = document.createElement('td');
                tdHoliday.className = 'px-4 py-3 text-center';
                const holidayCheck = document.createElement('input');
                holidayCheck.type = 'checkbox'; holidayCheck.className = 'w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500';
                holidayCheck.checked = appState.activeData.manualHolidays[day.date] === true;
                holidayCheck.onclick = (e) => window.updateHoliday(day.date, e.target.checked);
                tdHoliday.appendChild(holidayCheck);
                tr.appendChild(tdHoliday);
                
                // Columna 4: Tarde (Lateness Checkbox)
                const tdLate = document.createElement('td');
                tdLate.className = 'px-4 py-3 text-center';
                const lateCheck = document.createElement('input');
                lateCheck.type = 'checkbox'; lateCheck.className = 'w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500';
                lateCheck.checked = appState.activeData.lateness[day.date] === true;
                lateCheck.onclick = (e) => window.updateLateness(day.date, e.target.checked);
                tdLate.appendChild(lateCheck);
                tr.appendChild(tdLate);

                // Columna 5: Horas Equivalentes
                const tdEquiv = document.createElement('td');
                tdEquiv.className = 'px-4 py-3 text-right font-medium text-red-600';
                tdEquiv.textContent = day.totalEquiv.toFixed(1);
                tr.appendChild(tdEquiv);

                // Columna 6: Horas Extra
                const tdExtra = document.createElement('td');
                tdExtra.className = 'px-4 py-3 text-center';
                const extraInput = document.createElement('select');
                extraInput.className = 'w-16 p-1 border border-gray-300 rounded-lg text-xs bg-white table-select';
                extraInput.onchange = (e) => window.updateExtra(day.date, e.target.value);
                
                const currentExtra = appState.activeData.extras[day.date] || 0;
                [0, 1, 2, 4, 6, 8, 10, 12, 14, 16].forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val > 0 ? `+${val}h` : '0h';
                    if (val === currentExtra) option.selected = true;
                    extraInput.appendChild(option);
                });
                tdExtra.appendChild(extraInput);
                tr.appendChild(tdExtra);

                // Columna 7: Bruto
                const tdBruto = document.createElement('td');
                tdBruto.className = 'px-4 py-3 text-right font-bold';
                tdBruto.textContent = formatMoney(day.bruto);
                tr.appendChild(tdBruto);

                tbody.appendChild(tr);
            });
        }
        
        function renderTreasury() {
            const container = document.getElementById('treasury-container');
            container.innerHTML = '';
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const treasuryMonths = [];
            
            // Recopila los meses con datos históricos (y su configuración instantánea)
            for (const key in appState.historicalCache) {
                const [year, month] = key.split('-');
                const m = parseInt(month); const y = parseInt(year);
                const cachedData = appState.historicalCache[key];
                
                // Recalcula el mes con su snapshot de configuración
                const calc = performCalculation(
                    m, y, 
                    cachedData.extras || {}, 
                    cachedData.manualHolidays || {}, 
                    cachedData.shiftOverrides || {}, 
                    cachedData.lateness || {}, 
                    cachedData.configSnapshot || appState.config // Usa el snapshot si existe
                );
                
                treasuryMonths.push({ month: m, year: y, calc });
            }
            
            // Ordenar por año y mes descendente
            treasuryMonths.sort((a, b) => b.year * 100 + b.month - (a.year * 100 + a.month));

            if (treasuryMonths.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-6 text-center">No hay meses históricos guardados para mostrar la Tesorería.</p>';
                return;
            }

            treasuryMonths.forEach(({ month, year, calc }) => {
                const monthName = months[month - 1];
                const q1 = calc.quincenas.q1;
                const q2 = calc.quincenas.q2;

                const cardHTML = `
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden animate-fade-in">
                        <div class="p-5 border-b border-gray-100 bg-red-600/10 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">${monthName} ${year}</h3>
                            <span class="text-2xl font-extrabold text-emerald-600">${formatMoney(calc.netoFinal)}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2">
                            <div class="p-5 border-b md:border-b-0 md:border-r border-gray-100">
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">1° QUINCENA (1-15)</h4>
                                <p class="text-2xl font-bold text-gray-800 mb-3">${formatMoney(q1.neto)}</p>
                                <div class="space-y-1 text-sm">
                                    <p class="flex justify-between text-gray-700"><span>Bruto:</span> <span class="font-medium">${formatMoney(q1.bruto)}</span></p>
                                    <p class="flex justify-between text-red-500"><span>- Descuentos:</span> <span class="font-medium">${formatMoney(q1.desc)}</span></p>
                                    <p class="flex justify-between text-orange-600"><span>+ Viáticos:</span> <span class="font-medium">${formatMoney(q1.viaticos)}</span></p>
                                    <p class="flex justify-between text-red-700"><span>Feriados:</span> <span class="font-medium">${formatMoney(q1.feriados)}</span></p>
                                </div>
                            </div>
                            <div class="p-5">
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">2° QUINCENA (16-FIN)</h4>
                                <p class="text-2xl font-bold text-gray-800 mb-3">${formatMoney(q2.neto)}</p>
                                <div class="space-y-1 text-sm">
                                    <p class="flex justify-between text-gray-700"><span>Bruto:</span> <span class="font-medium">${formatMoney(q2.bruto)}</span></p>
                                    <p class="flex justify-between text-red-500"><span>- Descuentos:</span> <span class="font-medium">${formatMoney(q2.desc)}</span></p>
                                    <p class="flex justify-between text-orange-600"><span>+ Viáticos:</span> <span class="font-medium">${formatMoney(q2.viaticos)}</span></p>
                                    <p class="flex justify-between text-blue-600"><span>+ Presentismo:</span> <span class="font-medium">${formatMoney(q2.presentismo)}</span></p>
                                    <p class="flex justify-between text-purple-600"><span>+ Título:</span> <span class="font-medium">${formatMoney(q2.titulo)}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        }
        
        function renderRanking() {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            
            // Simular datos de otros usuarios para el ranking
            const myNeto = appState.activeData.calculation ? appState.activeData.calculation.netoFinal : 0;
            const myHours = appState.activeData.calculation ? appState.activeData.calculation.totalEquivHours : 0;

            const rankingData = [
                { name: appState.config.userName, team: appState.config.teamLetter, net: myNeto, hours: myHours, isMe: true },
                { name: "Juan P.", team: "A", net: myNeto * 1.05 + 10000, hours: myHours + 15, isMe: false },
                { name: "Maria L.", team: "C", net: myNeto * 0.98 - 5000, hours: myHours - 5, isMe: false },
                { name: "Carlos S.", team: "B", net: myNeto * 1.10 + 20000, hours: myHours + 25, isMe: false },
                { name: "Ana R.", team: "D", net: myNeto * 0.95 - 2000, hours: myHours - 10, isMe: false },
            ].sort((a, b) => b.net - a.net);

            rankingData.forEach((user, index) => {
                const position = index + 1;
                const medal = position === 1 ? '🥇' : (position === 2 ? '🥈' : (position === 3 ? '🥉' : ''));
                const cardClass = user.isMe ? 'bg-red-50 border-red-200 shadow-md' : 'bg-white border-gray-200';
                const nameClass = user.isMe ? 'text-red-700 font-extrabold' : 'text-gray-800 font-bold';

                list.innerHTML += `
                    <div class="flex items-center p-4 rounded-xl border ${cardClass} transition-all hover:shadow-lg">
                        <div class="text-3xl font-black mr-4 w-10 text-center text-gray-500">
                            ${medal || position}
                        </div>
                        <div class="flex-1">
                            <p class="text-lg ${nameClass} flex items-center gap-2">
                                ${user.name} 
                                <span class="text-[10px] font-bold bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded">Eq. ${user.team}</span>
                                ${user.isMe ? '<span class="text-[10px] font-bold bg-red-600 text-white px-1.5 py-0.5 rounded">TÚ</span>' : ''}
                            </p>
                            <p class="text-sm text-gray-500 mt-1">
                                ${formatMoney(user.net)} (Neto) | ${Math.round(user.hours)} H.Equiv.
                            </p>
                        </div>
                    </div>
                `;
            });
        }
        
        // --- PDF GENERATION ---
        function generatePdfReport() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
                showMessage('Librería de PDF no cargada. Intenta recargar la página.', 'error');
                return;
            }

            const { month, year } = appState.viewingMonth;
            const calc = appState.activeData.calculation;
            if (!calc) {
                showMessage('No hay datos calculados para generar el PDF.', 'error');
                return;
            }

            const doc = new window.jspdf.jsPDF();
            const config = appState.activeData.configSnapshot || appState.config;
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const fileName = `Reporte_Salario_${config.userName}_${monthNames[month - 1]}_${year}.pdf`;
            
            // Título
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`Liquidación Mensual: ${monthNames[month - 1]} de ${year}`, 15, 20);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Empleado: ${config.userName} (Equipo ${config.teamLetter})`, 15, 26);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-AR')}`, 15, 30);

            // Resumen General
            doc.setDrawColor(200);
            doc.line(15, 35, 195, 35); 
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`NETO FINAL ESTIMADO: ${formatMoney(calc.netoFinal)}`, 15, 42);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Horas Equivalentes Totales: ${Math.round(calc.totalEquivHours)}`, 15, 48);
            doc.text(`Bruto Total: ${formatMoney(calc.brutoTotal)}`, 15, 52);
            doc.text(`Descuentos (Tasa ${config.discountRate*100}%): ${formatMoney(calc.descuentoTotal)}`, 15, 56);
            doc.text(`Presentismo: ${formatMoney(calc.presentismo)} ${calc.hasLateness ? '(PERDIDO por Tarde/Ausencia)' : ''}`, 15, 60);

            // Tabla de Quincenas
            const quincenaData = [
                ['Concepto', '1ra Quincena', '2da Quincena'],
                ['Bruto', formatMoney(calc.quincenas.q1.bruto), formatMoney(calc.quincenas.q2.bruto)],
                ['Descuento', formatMoney(-calc.quincenas.q1.desc), formatMoney(-calc.quincenas.q2.desc)],
                ['Viáticos', formatMoney(calc.quincenas.q1.viaticos), formatMoney(calc.quincenas.q2.viaticos)],
                ['Feriados', formatMoney(calc.quincenas.q1.feriados), formatMoney(calc.quincenas.q2.feriados)],
                ['Presentismo', formatMoney(0), formatMoney(calc.quincenas.q2.presentismo)],
                ['Título', formatMoney(0), formatMoney(calc.quincenas.q2.titulo)],
                ['NETO', formatMoney(calc.quincenas.q1.neto), formatMoney(calc.quincenas.q2.neto)]
            ];

            doc.autoTable({
                startY: 70,
                head: [quincenaData[0]],
                body: quincenaData.slice(1),
                theme: 'striped',
                headStyles: { fillColor: [220, 50, 50], textColor: 255, fontStyle: 'bold' },
                footStyles: { fillColor: [240, 240, 240], fontStyle: 'bold' },
                styles: { fontSize: 8 },
                didDrawCell: (data) => {
                    if (data.row.section === 'body' && data.row.index === quincenaData.length - 2) { // Última fila de Neto
                        doc.setFillColor(230, 255, 230); doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        doc.setFont('helvetica', 'bold');
                    }
                }
            });

            let finalY = doc.autoTable.previous.finalY + 10;
            
            // Detalle Diario
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text("Detalle Diario de Turnos y Cálculos", 15, finalY);

            const dailyTableData = calc.dailyResults.map(d => [
                d.date, 
                d.turn.replace(/ \(.*\)/, ''), 
                d.isHoliday ? 'Sí' : 'No', 
                d.isLate ? 'Sí' : 'No',
                d.extraReal > 0 ? `+${d.extraReal}h` : '',
                d.totalEquiv.toFixed(1), 
                formatMoney(d.bruto)
            ]);

            doc.autoTable({
                startY: finalY + 5,
                head: [['Fecha', 'Turno', 'Feriado', 'Tarde', 'Extra', 'H. Eq.', 'Bruto']],
                body: dailyTableData,
                theme: 'grid',
                headStyles: { fillColor: [50, 50, 50], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 8 },
                columnStyles: { 5: { fontStyle: 'bold' }, 6: { halign: 'right' } }
            });

            doc.save(fileName);
        }
        // --- END RENDER FUNCTIONS ---
        
    </script>
</body>
</html>
